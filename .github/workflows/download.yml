name: Daily Options Download

on:
  schedule:
    # Run at 23:00 UTC (End of US trading day)
    - cron: '0 23 * * 1-5' 
  
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write
  actions: read

jobs:
  download-options:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: pip install pandas yfinance numpy scipy numpy

      - name: Run options download script
        id: download
        run: |
          # Run script and capture output to a log file
          python download_options.py > /tmp/work_log.txt 2>&1
          
          # Print to console for real-time debugging
          cat /tmp/work_log.txt
          
          # Save log to GITHUB_OUTPUT for the summary step
          echo "log<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/work_log.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Write work summary
        run: |
          echo "## Options Download Summary" >> $GITHUB_STEP_SUMMARY
          echo "Run completed on $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "### Execution Log" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.download.outputs.log }}" >> $GITHUB_STEP_SUMMARY

      - name: Commit and push options data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add options_data/
          
          # Only commit if there are actually changes
          git diff --staged --quiet || git commit -m "Add options data for $(date +'%Y-%m-%d')"
          
          git push
